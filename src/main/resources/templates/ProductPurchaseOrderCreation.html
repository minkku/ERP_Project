<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout/default_layout">

<th:block th:replace="~{fragments/header :: headerFragment}"></th:block>
<main id="main" class="main" style="width: 100%;">
    <form th:action="@{/ProductPurchaseOrderCreation}" method="post" th:object="${productOrderCustomDTO}" id="purchaseOrderForm">
    <section class="section">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <div class="component-quotation-modal-container">
                            <div class="component-quotation-modal-main">
                                <div class="component-quotation-modal-recipient">
                                    <div class="component-quotation-modal-recipient-title">
                                        <h6>공급자</h6>
                                    </div>
                                    <div class="component-quotation-modal-recipient-info">

                                        <ul>
                                            <li>
                                                <label for="component-quotation-modal-input-order-number">발주번호</label>
                                                <input type="text" id="component-quotation-modal-input-order-number" name="productOrderNumber" th:value="${productOrderNumber}" readonly>
                                                <label for="component-quotation-modal-input-member">담당자</label>
                                                <input type="text" id="component-quotation-modal-input-member" name="memberName" th:value="김미영" readonly>
                                            </li>
                                            <li>
                                                <label for="component-quotation-modal-input-supplier-delivery-date">납기일</label>
                                                <input type="date" id="component-quotation-modal-input-supplier-delivery-date" name="productOrderDeliveryDate">
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="component-quotation-modal-supplier">
                                    <div class="component-quotation-modal-supplier-title">
                                        <h6>공급 받는 자</h6>
                                        <br>
                                        <a href="#" class="gradient-color-btn blue js-show-component-quotation-modal" style="position: absolute; margin: 30px;">찾기</a>

                                    </div>
                                    <div class="component-quotation-modal-supplier-info">
                                        <ul>
                                            <li>
                                                <label for="component-quotation-modal-input-supplier-company-name">*상호</label>
                                                <input type="text" id="component-quotation-modal-input-supplier-company-name" name="businessvenderName">
                                                <label for="component-quotation-modal-input-supplier-company-number">사업자 등록번호</label>
                                                <input type="text" id="component-quotation-modal-input-supplier-company-number" name="businessvenderCompanynumber">
                                            </li>
                                            <li>
                                                <label for="component-quotation-modal-input-supplier-company-address">사업장 소재지</label>
                                                <input type="text" id="component-quotation-modal-input-supplier-company-address" name="businessvenderAddress">
                                            </li>
                                            <li>
                                                <label for="component-quotation-modal-input-supplier-sector">업태</label>
                                                <input type="text" id="component-quotation-modal-input-supplier-sector" name="businessvenderSmalltype">
                                                <label for="component-quotation-modal-input-supplier-business-type">업종</label>
                                                <input type="text" id="component-quotation-modal-input-supplier-business-type" name="businessvenderBigtype">
                                            </li>
                                            <li>
                                                <label for="component-quotation-modal-input-supplier-representative">대표자</label>
                                                <input type="text" id="component-quotation-modal-input-supplier-representative" name="businessvenderRepresentativename">
                                                <label for="component-quotation-modal-input-supplier-phone">연락처</label>
                                                <input type="text" id="component-quotation-modal-input-supplier-phone" name="businessvenderPhone">
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="component-quotation-modal-component-quotation-list" data-component-quotation-modal-component-quotation-list-top="0" data-component-quotation-modal-component-quotation-list-left="0">
                                    <table class="component-quotation-modal-component-quotation-list-table" id="component-quotation-modal-component-quotation-list-table">
                                        <colgroup>
                                            <col style="width: 15%">
                                            <col style="width: 18%">
                                            <col style="width: 10%">
                                            <col style="width: 8%">
                                            <col style="width: 14%">
                                            <col style="width: 8%">
                                            <col style="width: 14%">
                                            <col style="width: 14%">
                                            <col style="width: 18%">
                                        </colgroup>
                                        <tr>
                                            <td class="component-quotation-modal-component-quotation-list-top">추가</td>
                                            <td class="component-quotation-modal-component-quotation-list-top">항목</td>
                                            <td class="component-quotation-modal-component-quotation-list-top">수량</td>
                                            <td class="component-quotation-modal-component-quotation-list-top">단위</td>
                                            <td class="component-quotation-modal-component-quotation-list-top">단가</td>
                                            <td class="component-quotation-modal-component-quotation-list-top">통화</td>
                                            <td class="component-quotation-modal-component-quotation-list-top">공급가</td>
                                            <td class="component-quotation-modal-component-quotation-list-top">부가세</td>
                                            <td class="component-quotation-modal-component-quotation-list-top">비고</td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <button type="button" class="btn btn-primary add-row-btn">+</button>
                                                <button type="button" class="btn btn-danger remove-row-btn">-</button>
                                            </td>
                                            <td><input type="text"></td>
                                            <td><input type="text"></td>
                                            <td><input type="text"></td>
                                            <td><input type="text"></td>
                                            <td><input type="text" th:value="KOR"></td>
                                            <td><input type="text"></td>
                                            <td><input type="text"></td>
                                            <td><input type="text"></td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="component-quotation-modal-summary">
                                    <div class="component-quotation-modal-note">
                                        <textarea id="component-quotation-modal-total-note" name="productOrderItemDetail"></textarea>
                                    </div>
                                    <div class="component-quotation-modal-total">
                                        <div class="component-quotation-modal-total-line">
                                            <label for="component-quotation-modal-input-total-supply-value">공급가</label>
                                            <input type="text" id="component-quotation-modal-input-total-supply-value">
                                        </div>
                                        <div class="component-quotation-modal-total-line">
                                            <label for="component-quotation-modal-input-total-value-added-tax">부가세</label>
                                            <input type="text" id="component-quotation-modal-input-total-value-added-tax">
                                        </div>
                                        <div class="component-quotation-modal-total-line">
                                            <label for="component-quotation-modal-input-total-subtotal">소계</label>
                                            <input type="text" id="component-quotation-modal-input-total-subtotal" name="productOrderPriceAmount">
                                        </div>
                                    </div>
                                    <div class="component-quotation-modal-submit-button">
                                        <button type="submit" onclick="submitForm()" class="gradient-color-btn blue" style="width: 100px;">발주등록</button>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>
    </form>
    <th:block th:replace="~{fragments/footer:: footerFragment}"></th:block>
    <!-- registration modal -->
    <div class="component-quotation-modal-container wrap-component-quotation-modal js-component-quotation-modal">
        <div class="component-quotation-modal-main">
            <div class="component-quotation-modal-recipient">
                <div class="component-quotation-modal-component-quotation-list" data-component-quotation-modal-component-quotation-list-top="0" data-component-quotation-modal-component-quotation-list-left="0">
                    <table class="component-quotation-modal-component-quotation-list-table" id="s-component-quotation-modal-component-quotation-list-table">
                        <colgroup>
                            <col style="width: 50%">
                            <col style="width: 18%">
                        </colgroup>
                        <tr>
                            <td class="component-quotation-modal-component-quotation-list-top">상호명</td>
                        </tr>
                    </table>
                </div>
                <div class="component-quotation-modal-submit-button">
                    <a href="#" class="gradient-color-btn blue js-hide-component-quotation-modal" style="width: 100px;">닫기</a>
                </div>
            </div>
        </div>
    </div>
</main><!-- End #main -->

<script src="assets/vendor/jquery/jquery-3.2.1.min.js"></script>
<script th:inline="javascript">
    $('.js-show-component-quotation-modal').on('click', function(e) { // 조회
        e.preventDefault();
        $('.js-component-quotation-modal').addClass('show-component-quotation-modal');
    });
    $('.js-hide-component-quotation-modal').on('click', function() { // 취소

        $('.js-component-quotation-modal').removeClass('show-component-quotation-modal');
    });
    var productOrderNumber = document.getElementById('component-quotation-modal-input-order-number').value;

    $(document).on('click', '.add-row-btn', function() {
        var currentRow = $(this).closest('tr');
        var newRow = currentRow.clone();
        newRow.find('input').val('');
        currentRow.after(newRow);
    });

    $(document).on('click', '.remove-row-btn', function() {
        $(this).closest('tr').remove();
        updateTotalValues();
    });

    // 'input' 이벤트 발생 시에도 값을 업데이트
    $(document).on('input', 'table.component-quotation-modal-component-quotation-list-table tbody tr:not(:first) input', function() {
        updateValues();
        updateTotalValues();
    });

    function updateValues() {
        // 현재 수정 중인 행의 값을 업데이트
        var currentRow = $(document.activeElement).closest('tr');
        var quantity = currentRow.find('td:eq(2) input').val();
        var unitPrice = currentRow.find('td:eq(4) input').val();

        // 3번째(td:eq(2))와 5번째(td:eq(4)) 값을 곱한 결과를 7번째(td:eq(6))에 설정
        currentRow.find('td:eq(6) input').val((parseFloat(quantity) * parseFloat(unitPrice)).toFixed(0));

        // 7번째(td:eq(6)) 값과 0.1을 곱한 결과를 8번째(td:eq(7))에 설정
        currentRow.find('td:eq(7) input').val((parseFloat(currentRow.find('td:eq(6) input').val()) * 0.1).toFixed(0));
    }

    function updateTotalValues() {
        var totalSupplyValue = 0;
        var totalValueAddedTax = 0;

        // 각 행의 7번째(td:eq(6))와 8번째(td:eq(7)) 열 값을 합산
        $('table.component-quotation-modal-component-quotation-list-table tbody tr:not(:first)').each(function() {
            var quantity = $(this).find('td:eq(2) input').val();
            var unitPrice = $(this).find('td:eq(4) input').val();

            // 값이 비어있을 경우 0으로 처리
            quantity = quantity === '' ? 0 : parseFloat(quantity);
            unitPrice = unitPrice === '' ? 0 : parseFloat(unitPrice);

            var subtotal = quantity * unitPrice;
            totalSupplyValue += subtotal;
            totalValueAddedTax += subtotal * 0.1;
        });

        // '공급가' 필드에 값을 설정
        $('#component-quotation-modal-input-total-supply-value').val(totalSupplyValue.toFixed(0));

        // '부가세' 필드에 값을 설정
        $('#component-quotation-modal-input-total-value-added-tax').val(totalValueAddedTax.toFixed(0));

        // '소계' 필드에 두 값을 합산하여 설정
        var subtotal = totalSupplyValue + totalValueAddedTax;
        $('#component-quotation-modal-input-total-subtotal').val(subtotal.toFixed(0));
    }

    function collectData() {
        var data = {};
        data.productOrderNumber = productOrderNumber;
        data.productOrderItemList = [];

        $('table.component-quotation-modal-component-quotation-list-table tbody tr:not(:first)').each(function() {
            var row = {};
            row.productId = $(this).find('td:eq(1) input').val();
            row.productOrderItemQuantity = $(this).find('td:eq(2) input').val();
            row.productOrderItemPrice = $(this).find('td:eq(4) input').val();
            row.productOrderItemTotalprice = $(this).find('td:eq(6) input').val();
            row.productOrderItemTotalpriceaddedtax = $(this).find('td:eq(7) input').val();
            row.productOrderItemNote = $(this).find('td:eq(8) input').val();

            data.productOrderItemList.push(row);
        });

        return JSON.stringify(data);
    }

    function submitForm() {
        document.getElementById("purchaseOrderForm").submit();
        var productOrderItemList = collectData();

        $.ajax({
            type: "POST",
            url: "/ProductPurchaseOrderItemCreation",
            contentType: "application/json",
            data: productOrderItemList,
            success: function (result) {
                console.log(result);
                // 성공적으로 서버에 전송된 후 실행할 코드
            },
            error: function (e) {
                console.log("Error:", e);
            }
        });
    }

    $(document).ready(function() {
        // form submit 방지 및 submitForm 함수 실행
        $("#purchaseOrderForm").submit(function(event) {
            event.preventDefault();
            submitForm();
        });
    });
</script>
</body>
</html>